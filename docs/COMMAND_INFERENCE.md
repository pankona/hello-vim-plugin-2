# コマンド推論機能の設計

> **注意**: このドキュメントは設計の詳細を記述しています。実装時には必ず`docs/TASKS.md`と合わせて参照し、タスクの進捗状況を確認してください。

## 概要

makaseroのチャット機能において、ユーザーの自然言語による要求を適切なコマンドに変換する機能の設計を記述します。
この機能は、「どんな言語で構成されていますか？」「テストカバレッジは？」といった質問に対して、
LLMを活用して適切なコマンドを推論し、その結果を解釈して回答します。

## 動作フロー

1. ユーザーからの質問を受信
   例：
   - 「このリポジトリはどんな言語で構成されていますか？」
   - 「テストカバレッジを確認したい」
   - 「未使用の関数を探したい」
   など

2. LLMへのプロンプト送信
   ```
   ユーザーの要求「[ユーザーの質問]」を実現するために適切なコマンドを提案してください。
   
   要件：
   - findやgrepなどのLinuxコマンドが使用可能
   - パイプやリダイレクトなどのシェル機能も使用可能
   - 読み取り専用の操作のみ許可
   - 結果は人間が理解しやすい形式で表示
   
   出力フォーマット：
   ---COMMAND---
   [実行すべきコマンド]
   ---EXPLANATION---
   [このコマンドが何を行い、どのように結果を解釈すべきかの説明]
   ---END---
   ```

3. LLMからのレスポンス例
   ```
   # 言語構成の分析の場合：
   ---COMMAND---
   find . -type f -not -path "*/\.*" -not -path "*/vendor/*" | sed 's/.*\.//' | sort | uniq -c | sort -nr
   ---EXPLANATION---
   このコマンドは：
   1. findで全ファイルを検索（隠しファイルとvendorディレクトリを除外）
   2. 拡張子を抽出してカウント
   3. 結果を降順で表示
   結果から各ファイルタイプの分布が分かります。
   ---END---

   # テストカバレッジの確認の場合：
   ---COMMAND---
   go test ./... -cover
   ---EXPLANATION---
   このコマンドは：
   1. すべてのパッケージのテストを実行
   2. カバレッジレポートを生成
   結果からテストカバレッジの割合が分かります。
   ---END---
   ```

4. コマンドの実行と結果の取得
   - 提案されたコマンドの安全性を確認
   - コマンドを実行
   - 実行結果を取得

5. 結果の解釈とレスポンス生成
   - 実行結果をLLMに渡して解釈
   - 人間が理解しやすい形式でレスポンスを生成

## 実装のポイント

### 1. 安全性の確保
- 実行可能なコマンドの制限
  - システムに影響を与えるコマンド（rm, mv等）は禁止
  - 読み取り専用の操作のみ許可
- コマンド実行前の検証
  - コマンドのパターンマッチによる検証
  - 許可されたコマンドのホワイトリスト管理

### 2. コマンド推論の精度向上
- コンテキストの活用
  - プロジェクトの種類（Go, Python等）
  - ディレクトリ構造
  - 直前の会話履歴
- 一般的なタスクのパターン化
  - ファイル検索
  - コード解析
  - テスト実行
  など

### 3. レスポンスフォーマット
```
[質問に対する直接的な回答]

実行したコマンド：
$ [実行したコマンド]

結果の解釈：
[結果の詳細な説明]

補足情報：
[追加の文脈や提案]
```

## 今後の拡張可能性

1. コマンドの最適化
   - より効率的なコマンドの提案
   - プロジェクト固有の要件への対応

2. 対話的な改善
   - 結果に基づく追加のコマンド提案
   - ユーザーのフィードバックを活用した学習

3. カスタマイズ機能
   - プロジェクト固有のコマンドの登録
   - ユーザー好みのコマンドスタイルの学習

## 実装手順

1. プロンプトの実装
   - LLMへの質問フォーマットの定義
   - コマンド提案の要件定義

2. コマンド実行機能の実装
   - 安全性チェックの実装
   - コマンド実行環境の整備

3. 結果解釈機能の実装
   - 実行結果のパース
   - 人間が理解しやすい形式への変換

4. テストの実装
   - 様々なユースケースのテスト
   - エッジケースの処理確認 